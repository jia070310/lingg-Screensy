name: ç¼–è¯‘æ‰“åŒ…

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'  # å½“åˆ›å»ºä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ç¼–è¯‘EXEæ–‡ä»¶
      run: |
        pyinstaller build_exe.spec --clean --noconfirm
        
    - name: å®‰è£…Inno Setup
      run: |
        $innoUrl = "https://jrsoftware.org/download.php/is.exe"
        $innoPath = "$env:ProgramFiles(x86)\Inno Setup 6"
        $isccPath = "$innoPath\ISCC.exe"
        $installerPath = "$env:TEMP\is.exe"
        
        if (-not (Test-Path $isccPath)) {
          Write-Host "ä¸‹è½½Inno Setup..."
          
          # é‡è¯•æœºåˆ¶ï¼šæœ€å¤šé‡è¯•3æ¬¡
          $maxRetries = 3
          $retryCount = 0
          $downloadSuccess = $false
          
          while (($retryCount -lt $maxRetries) -and (-not $downloadSuccess)) {
            try {
              $retryCount++
              Write-Host "å°è¯•ä¸‹è½½ (ç¬¬ $retryCount æ¬¡)..."
              
              # ä½¿ç”¨æ›´é•¿çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•å‚æ•°
              $ProgressPreference = 'SilentlyContinue'
              Invoke-WebRequest -Uri $innoUrl -OutFile $installerPath -TimeoutSec 120 -UseBasicParsing
              
              if ((Test-Path $installerPath) -and ((Get-Item $installerPath).Length -gt 0)) {
                Write-Host "ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $((Get-Item $installerPath).Length) å­—èŠ‚"
                $downloadSuccess = $true
              } else {
                throw "ä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆæˆ–ä¸ºç©º"
              }
            }
            catch {
              Write-Warning "ä¸‹è½½å¤±è´¥ (ç¬¬ $retryCount æ¬¡): $_"
              if (Test-Path $installerPath) {
                Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              }
              if ($retryCount -lt $maxRetries) {
                $waitTime = $retryCount * 5
                Write-Host "ç­‰å¾… ${waitTime} ç§’åé‡è¯•..."
                Start-Sleep -Seconds $waitTime
              }
            }
          }
          
          if (-not $downloadSuccess) {
            Write-Host "ç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Chocolatey å®‰è£…..."
            # å°è¯•ä½¿ç”¨ Chocolatey å®‰è£…
            $chocoAvailable = $null
            try {
              $chocoAvailable = Get-Command choco -ErrorAction Stop
            } catch {
              Write-Host "Chocolatey æœªæ‰¾åˆ°ï¼Œå°è¯•å®‰è£… Chocolatey..."
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
              $chocoAvailable = Get-Command choco -ErrorAction SilentlyContinue
            }
            
            if ($chocoAvailable) {
              Write-Host "ä½¿ç”¨ Chocolatey å®‰è£… Inno Setup..."
              choco install innosetup -y
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Chocolatey å®‰è£… Inno Setup å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
                exit 1
              }
            } else {
              Write-Error "ç»è¿‡ $maxRetries æ¬¡å°è¯•åä»æ— æ³•ä¸‹è½½ Inno Setupï¼Œä¸”æ— æ³•ä½¿ç”¨ Chocolatey"
              exit 1
            }
          } else {
            Write-Host "å®‰è£…Inno Setup..."
            # ä½¿ç”¨ /DIR å‚æ•°æŒ‡å®šå®‰è£…ç›®å½•ï¼Œç¡®ä¿å®‰è£…åˆ°é¢„æœŸä½ç½®
            $installDir = "$env:ProgramFiles(x86)\Inno Setup 6"
            $installArgs = "/SILENT /ALLUSERS /DIR=`"$installDir`""
            Write-Host "å®‰è£…å‚æ•°: $installArgs"
            $installProcess = Start-Process -FilePath $installerPath -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
            $installExitCode = $installProcess.ExitCode
            Write-Host "å®‰è£…ç¨‹åºé€€å‡ºä»£ç : $installExitCode"
            
            if ($installExitCode -ne 0 -and $installExitCode -ne $null) {
              Write-Warning "æŒ‡å®šç›®å½•å®‰è£…å¤±è´¥ï¼Œå°è¯•é»˜è®¤å®‰è£…..."
              $installProcess = Start-Process -FilePath $installerPath -ArgumentList "/SILENT /ALLUSERS" -Wait -PassThru -NoNewWindow
              $installExitCode = $installProcess.ExitCode
              Write-Host "é»˜è®¤å®‰è£…é€€å‡ºä»£ç : $installExitCode"
            }
            
            Start-Sleep -Seconds 15
            
            # è°ƒè¯•ï¼šåˆ—å‡º Program Files ç›®å½•
            Write-Host "æ£€æŸ¥å®‰è£…ç›®å½•..."
            if (Test-Path "$env:ProgramFiles(x86)") {
              Write-Host "Program Files (x86) ç›®å½•å†…å®¹:"
              Get-ChildItem "$env:ProgramFiles(x86)" -Directory -ErrorAction SilentlyContinue | Select-Object -First 20 Name | ForEach-Object { Write-Host "  - $($_.Name)" }
            }
            if (Test-Path "$env:ProgramFiles") {
              Write-Host "Program Files ç›®å½•å†…å®¹:"
              Get-ChildItem "$env:ProgramFiles" -Directory -ErrorAction SilentlyContinue | Select-Object -First 20 Name | ForEach-Object { Write-Host "  - $($_.Name)" }
            }
            
            # å°è¯•æœç´¢ ISCC.exe
            Write-Host "æœç´¢ ISCC.exe..."
            $searchPaths = @("$env:ProgramFiles(x86)", "$env:ProgramFiles")
            foreach ($searchPath in $searchPaths) {
              if (Test-Path $searchPath) {
                $foundFiles = Get-ChildItem -Path $searchPath -Filter "ISCC.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 5
                if ($foundFiles) {
                  Write-Host "æ‰¾åˆ° ISCC.exe æ–‡ä»¶:"
                  foreach ($file in $foundFiles) {
                    Write-Host "  - $($file.FullName)"
                  }
                }
              }
            }
            
            # æ£€æŸ¥å¯èƒ½çš„å®‰è£…è·¯å¾„
            $possiblePaths = @(
              "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe",
              "$env:ProgramFiles\Inno Setup 6\ISCC.exe",
              "$env:ProgramFiles(x86)\Inno Setup 5\ISCC.exe",
              "$env:ProgramFiles\Inno Setup 5\ISCC.exe"
            )
            
            # ç­‰å¾…å®‰è£…å®Œæˆ
            $timeout = 120
            $elapsed = 0
            $found = $false
            while (-not $found -and $elapsed -lt $timeout) {
              foreach ($path in $possiblePaths) {
                if (Test-Path $path) {
                  Write-Host "æ‰¾åˆ° Inno Setup: $path"
                  $isccPath = $path
                  $found = $true
                  break
                }
              }
              if (-not $found) {
                Start-Sleep -Seconds 3
                $elapsed += 3
                Write-Host "ç­‰å¾…å®‰è£…å®Œæˆ... (å·²ç­‰å¾… $elapsed ç§’)"
              }
            }
            
            # æ¸…ç†å®‰è£…ç¨‹åº
            if (Test-Path $installerPath) {
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
            }
          }
        }
        
        # æœ€ç»ˆæ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è·¯å¾„
        $possiblePaths = @(
          "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe",
          "$env:ProgramFiles\Inno Setup 6\ISCC.exe",
          "$env:ProgramFiles(x86)\Inno Setup 5\ISCC.exe",
          "$env:ProgramFiles\Inno Setup 5\ISCC.exe"
        )
        
        $finalPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $finalPath = $path
            break
          }
        }
        
        # å¦‚æœåœ¨é¢„å®šä¹‰è·¯å¾„ä¸­æ‰¾ä¸åˆ°ï¼Œæœç´¢æ•´ä¸ªç³»ç»Ÿ
        if (-not $finalPath) {
          Write-Host "åœ¨é¢„å®šä¹‰è·¯å¾„ä¸­æœªæ‰¾åˆ°ï¼Œæœç´¢æ•´ä¸ªç³»ç»Ÿ..."
          $searchPaths = @("$env:ProgramFiles(x86)", "$env:ProgramFiles")
          foreach ($searchPath in $searchPaths) {
            if (Test-Path $searchPath) {
              $foundFile = Get-ChildItem -Path $searchPath -Filter "ISCC.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($foundFile) {
                $finalPath = $foundFile.FullName
                Write-Host "é€šè¿‡æœç´¢æ‰¾åˆ°: $finalPath"
                break
              }
            }
          }
        }
        
        if ($finalPath) {
          Write-Host "Inno Setupå·²å®‰è£…: $finalPath"
          # æ›´æ–°å…¨å±€å˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          $env:INNO_SETUP_PATH = $finalPath
        } else {
          Write-Error "Inno Setupå®‰è£…å¤±è´¥ï¼Œæœªæ‰¾åˆ° ISCC.exe"
          Write-Host "æ£€æŸ¥çš„é¢„å®šä¹‰è·¯å¾„:"
          foreach ($path in $possiblePaths) {
            Write-Host "  - $path"
          }
          Write-Host "å·²æœç´¢ç›®å½•: $env:ProgramFiles(x86), $env:ProgramFiles"
          exit 1
        }
        
    - name: æ‰“åŒ…å®‰è£…ç¨‹åº
      run: |
        # æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ Inno Setup è·¯å¾„
        $possiblePaths = @(
          "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe",
          "$env:ProgramFiles\Inno Setup 6\ISCC.exe",
          "$env:ProgramFiles(x86)\Inno Setup 5\ISCC.exe",
          "$env:ProgramFiles\Inno Setup 5\ISCC.exe"
        )
        
        $isccPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $isccPath = $path
            break
          }
        }
        
        # å¦‚æœåœ¨é¢„å®šä¹‰è·¯å¾„ä¸­æ‰¾ä¸åˆ°ï¼Œæœç´¢æ•´ä¸ªç³»ç»Ÿ
        if (-not $isccPath) {
          Write-Host "åœ¨é¢„å®šä¹‰è·¯å¾„ä¸­æœªæ‰¾åˆ°ï¼Œæœç´¢æ•´ä¸ªç³»ç»Ÿ..."
          $searchPaths = @("$env:ProgramFiles(x86)", "$env:ProgramFiles")
          foreach ($searchPath in $searchPaths) {
            if (Test-Path $searchPath) {
              $foundFile = Get-ChildItem -Path $searchPath -Filter "ISCC.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($foundFile) {
                $isccPath = $foundFile.FullName
                Write-Host "é€šè¿‡æœç´¢æ‰¾åˆ°: $isccPath"
                break
              }
            }
          }
        }
        
        if ($isccPath) {
          Write-Host "æ‰¾åˆ° Inno Setup: $isccPath"
          Write-Host "å¼€å§‹æ‰“åŒ…å®‰è£…ç¨‹åº..."
          & $isccPath installer.iss
          if ($LASTEXITCODE -ne 0) {
            Write-Error "æ‰“åŒ…å¤±è´¥ï¼Œé€€å‡ºä»£ç : $LASTEXITCODE"
            exit 1
          }
          Write-Host "æ‰“åŒ…å®Œæˆ"
        } else {
          Write-Error "Inno Setupæœªæ‰¾åˆ°ï¼Œæ£€æŸ¥çš„è·¯å¾„:"
          foreach ($path in $possiblePaths) {
            Write-Host "  - $path"
          }
          Write-Host "å·²æœç´¢ç›®å½•: $env:ProgramFiles(x86), $env:ProgramFiles"
          exit 1
        }
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: å®‰è£…ç¨‹åº
        path: |
          dist/çµæ„Ÿå½•å±å·¥å…·å®‰è£…ç¨‹åº.exe
          dist/çµæ„Ÿå½•å±å·¥å…·.exe
        retention-days: 30
    
    - name: å‘å¸ƒåˆ° Releases
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/çµæ„Ÿå½•å±å·¥å…·å®‰è£…ç¨‹åº.exe
          dist/çµæ„Ÿå½•å±å·¥å…·.exe
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“¦ å®‰è£…ç¨‹åº
          
          - **çµæ„Ÿå½•å±å·¥å…·å®‰è£…ç¨‹åº.exe** - å®Œæ•´å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
            - è‡ªåŠ¨å®‰è£… FFmpeg å¹¶é…ç½®ç¯å¢ƒå˜é‡
            - åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¾èµ–å’Œèµ„æºæ–‡ä»¶
          - **çµæ„Ÿå½•å±å·¥å…·.exe** - ä¾¿æºç‰ˆå¯æ‰§è¡Œæ–‡ä»¶
            - å¯ç›´æ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…
            - éœ€è¦æ‰‹åŠ¨é…ç½® FFmpeg ç¯å¢ƒå˜é‡
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¹¶è¿è¡Œ `çµæ„Ÿå½•å±å·¥å…·å®‰è£…ç¨‹åº.exe`ï¼ˆæ¨èï¼‰
          2. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…
          3. å®‰è£…ç¨‹åºä¼šè‡ªåŠ¨å®‰è£… FFmpeg åˆ° `C:\ffmpeg` å¹¶é…ç½®ç¯å¢ƒå˜é‡
          4. å®‰è£…å®Œæˆåï¼Œä»å¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨ç¨‹åº
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          
          æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          
          - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }})
          - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

