name: 编译打包

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 编译EXE文件
      run: |
        pyinstaller build_exe.spec --clean --noconfirm
        
    - name: 安装Inno Setup
      run: |
        $innoUrl = "https://jrsoftware.org/download.php/is.exe"
        $innoPath = "$env:ProgramFiles(x86)\Inno Setup 6"
        $isccPath = "$innoPath\ISCC.exe"
        $installerPath = "$env:TEMP\is.exe"
        
        if (-not (Test-Path $isccPath)) {
          Write-Host "下载Inno Setup..."
          
          # 重试机制：最多重试3次
          $maxRetries = 3
          $retryCount = 0
          $downloadSuccess = $false
          
          while (($retryCount -lt $maxRetries) -and (-not $downloadSuccess)) {
            try {
              $retryCount++
              Write-Host "尝试下载 (第 $retryCount 次)..."
              
              # 使用更长的超时时间和重试参数
              $ProgressPreference = 'SilentlyContinue'
              Invoke-WebRequest -Uri $innoUrl -OutFile $installerPath -TimeoutSec 120 -UseBasicParsing
              
              if ((Test-Path $installerPath) -and ((Get-Item $installerPath).Length -gt 0)) {
                Write-Host "下载成功，文件大小: $((Get-Item $installerPath).Length) 字节"
                $downloadSuccess = $true
              } else {
                throw "下载的文件无效或为空"
              }
            }
            catch {
              Write-Warning "下载失败 (第 $retryCount 次): $_"
              if (Test-Path $installerPath) {
                Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              }
              if ($retryCount -lt $maxRetries) {
                $waitTime = $retryCount * 5
                Write-Host "等待 ${waitTime} 秒后重试..."
                Start-Sleep -Seconds $waitTime
              }
            }
          }
          
          if (-not $downloadSuccess) {
            Write-Host "直接下载失败，尝试使用 Chocolatey 安装..."
            # 尝试使用 Chocolatey 安装
            $chocoAvailable = $null
            try {
              $chocoAvailable = Get-Command choco -ErrorAction Stop
            } catch {
              Write-Host "Chocolatey 未找到，尝试安装 Chocolatey..."
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
              $chocoAvailable = Get-Command choco -ErrorAction SilentlyContinue
            }
            
            if ($chocoAvailable) {
              Write-Host "使用 Chocolatey 安装 Inno Setup..."
              choco install innosetup -y
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Chocolatey 安装 Inno Setup 失败，退出代码: $LASTEXITCODE"
                exit 1
              }
            } else {
              Write-Error "经过 $maxRetries 次尝试后仍无法下载 Inno Setup，且无法使用 Chocolatey"
              exit 1
            }
          } else {
            Write-Host "安装Inno Setup..."
            Start-Process -FilePath $installerPath -ArgumentList "/SILENT /ALLUSERS" -Wait
            Start-Sleep -Seconds 5
            
            # 等待安装完成
            $timeout = 60
            $elapsed = 0
            while ((-not (Test-Path $isccPath)) -and ($elapsed -lt $timeout)) {
              Start-Sleep -Seconds 2
              $elapsed += 2
            }
            
            # 清理安装程序
            if (Test-Path $installerPath) {
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
            }
          }
        }
        
        if (Test-Path $isccPath) {
          Write-Host "Inno Setup已安装: $isccPath"
        } else {
          Write-Error "Inno Setup安装失败"
          exit 1
        }
        
    - name: 打包安装程序
      run: |
        $isccPath = "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $isccPath) {
          Write-Host "开始打包安装程序..."
          & $isccPath installer.iss
          if ($LASTEXITCODE -ne 0) {
            Write-Error "打包失败，退出代码: $LASTEXITCODE"
            exit 1
          }
          Write-Host "打包完成"
        } else {
          Write-Error "Inno Setup未找到: $isccPath"
          exit 1
        }
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: 安装程序
        path: |
          dist/灵感录屏工具安装程序.exe
          dist/灵感录屏工具.exe
        retention-days: 30

